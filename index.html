<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>ÆX N-Back . 2-Back Task</title>

<style>
    body {
        background: #0d0d0d;
        color: #ffffff;
        font-family: Arial, sans-serif;
        text-align: center;
        padding-top: 80px;
        margin: 0;
    }

    h1 {
        font-size: 52px;
        margin-bottom: 30px;
    }

    h2 {
        font-size: 32px;
        margin-top: 10px;
        margin-bottom: 30px;
    }

    h3 {
        font-size: 22px;
        margin-top: 40px;
        margin-bottom: 15px;
    }

    #instructions {
        font-size: 20px;
        margin-bottom: 30px;
    }

    #letter {
        font-size: 100px;
        font-weight: bold;
        margin-bottom: 40px;
        min-height: 120px;
    }

    .btn {
        font-size: 24px;
        padding: 14px 32px;
        margin: 8px;
        background: #1b1b1b;
        border: 2px solid #5fffd2;
        color: #5fffd2;
        cursor: pointer;
        border-radius: 8px;
    }

    .btn:hover {
        background: #5fffd2;
        color: #000000;
    }

    #startBtn {
        margin-top: 30px;
    }

    #result {
        font-size: 20px;
        margin-top: 40px;
        line-height: 1.6;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
    }

    #result p {
        margin: 6px 0;
    }

    #legend ul {
        text-align: left;
        display: inline-block;
        margin: 0;
        padding-left: 20px;
    }

    #legend li {
        margin-bottom: 6px;
    }

    .badge-container {
        margin-top: 25px;
        margin-bottom: 10px;
    }

    .badge-label {
        font-size: 18px;
        margin-bottom: 8px;
    }

    .badge-pill {
        display: inline-block;
        padding: 8px 18px;
        border-radius: 999px;
        font-size: 16px;
        font-weight: bold;
    }

    .badge-good {
        background-color: #1f8a70;
        color: #ffffff;
    }

    .badge-normal {
        background-color: #b38f1b;
        color: #000000;
    }

    .badge-high {
        background-color: #b3261e;
        color: #ffffff;
    }

    .note {
        font-size: 12px;
        margin-top: 35px;
        color: #cccccc;
        text-align: center;
    }
</style>
</head>

<body>

<h1>2-Back Task</h1>

<div id="instructions">
    Premi "Inizia" per cominciare.<br>
    Premi la barra spaziatrice solo quando la lettera è uguale a quella di <strong>due prove prima</strong>.
</div>

<button id="startBtn" class="btn">Inizia</button>

<div id="letter" style="display:none;"></div>

<div id="result"></div>

<script>
/* ------------------------------
   CONFIGURAZIONE
--------------------------------*/

// inserisci qui la URL della tua Web App Google Apps Script
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwEvLybsVQvSQnp8J47Maq704jg3DbBc2mD6xst-ZuQBxpU61WtxeJaaKTaZ-vADCiJtw/exec";

const N_LEVEL = 2;
const NUM_TRIALS = 80;           // durata moderata
const TARGET_PROB = 0.3;         // circa 30 percent di target
const STIM_MS = 500;             // durata stimolo
const ISI_MS = 1500;             // intervallo vuoto

const LETTERS = "ABCDEFGHJKLMNPQRTUVWYZ".split("");

let sequence = [];
let trials = [];
let currentTrial = 0;
let trialStartTime = 0;
let respondedThisTrial = false;
let running = false;

/* ------------------------------
   UTILITY
--------------------------------*/

function randomLetterDifferentFrom(letter) {
    const options = LETTERS.filter(l => l !== letter);
    return options[Math.floor(Math.random() * options.length)];
}

function avg(arr) {
    if (!arr.length) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
}

function interpretNBack(accuracyPercent, misses, falseAlarms) {
    if (accuracyPercent >= 85 && falseAlarms <= 3) {
        return {
            label: "Ottima memoria di lavoro e controllo attentivo",
            cssClass: "badge-good"
        };
    } else if (accuracyPercent >= 70) {
        return {
            label: "Performance nella norma. possibile affaticamento sotto carico",
            cssClass: "badge-normal"
        };
    } else {
        return {
            label: "In questo test emergono difficoltà nel mantenere e aggiornare le informazioni",
            cssClass: "badge-high"
        };
    }
}

/* ------------------------------
   AVVIO TEST
--------------------------------*/

document.getElementById("startBtn").onclick = () => {
    document.getElementById("instructions").style.display = "none";
    document.getElementById("startBtn").style.display = "none";

    document.getElementById("letter").style.display = "block";

    window.addEventListener("keydown", handleKeydown);
    running = true;

    generateSequence();
    nextTrial();
};

/* ------------------------------
   GENERAZIONE SEQUENZA
--------------------------------*/

function generateSequence() {
    sequence = [];
    for (let i = 0; i < NUM_TRIALS; i++) {
        if (i < N_LEVEL) {
            const letter = LETTERS[Math.floor(Math.random() * LETTERS.length)];
            sequence.push(letter);
        } else {
            const makeTarget = Math.random() < TARGET_PROB;
            if (makeTarget) {
                sequence.push(sequence[i - N_LEVEL]);
            } else {
                const prev = sequence[i - N_LEVEL];
                sequence.push(randomLetterDifferentFrom(prev));
            }
        }
    }
}

/* ------------------------------
   TASTIERA
--------------------------------*/

function handleKeydown(e) {
    if (!running) return;
    if (e.code !== "Space" && e.key !== " ") return;
    if (respondedThisTrial) return;

    respondedThisTrial = true;
    const rt = Math.round(performance.now() - trialStartTime);

    const t = trials[currentTrial - 1];
    t.responded = true;
    t.rt = rt;

    if (t.isTarget) {
        t.hit = true;
        t.miss = false;
        t.falseAlarm = false;
        t.correctRejection = false;
    } else {
        t.hit = false;
        t.miss = false;
        t.falseAlarm = true;
        t.correctRejection = false;
    }
}

/* ------------------------------
   NUOVO TRIAL
--------------------------------*/

function nextTrial() {
    if (currentTrial >= NUM_TRIALS) {
        finishTest();
        return;
    }

    respondedThisTrial = false;

    const letter = sequence[currentTrial];
    const isTarget = currentTrial >= N_LEVEL && letter === sequence[currentTrial - N_LEVEL];

    const letterDiv = document.getElementById("letter");
    letterDiv.innerHTML = letter;

    trialStartTime = performance.now();

    trials.push({
        index: currentTrial + 1,
        letter: letter,
        isTarget: isTarget,
        responded: false,
        rt: null,
        hit: false,
        miss: false,
        falseAlarm: false,
        correctRejection: false
    });

    currentTrial++;

    setTimeout(() => {
        letterDiv.innerHTML = "";
        setTimeout(() => {
            const t = trials[currentTrial - 1];
            if (t.isTarget && !t.responded) {
                t.miss = true;
            }
            if (!t.isTarget && !t.responded) {
                t.correctRejection = true;
            }
            nextTrial();
        }, ISI_MS);
    }, STIM_MS);
}

/* ------------------------------
   FINE TEST
--------------------------------*/

function finishTest() {
    running = false;
    window.removeEventListener("keydown", handleKeydown);
    document.getElementById("letter").style.display = "none";

    let targetCount = 0;
    let hits = 0;
    let misses = 0;
    let falseAlarms = 0;
    let correctRejections = 0;
    let rtsHits = [];

    trials.forEach(t => {
        if (t.isTarget) targetCount++;
        if (t.hit) {
            hits++;
            if (t.rt != null) rtsHits.push(t.rt);
        }
        if (t.miss) misses++;
        if (t.falseAlarm) falseAlarms++;
        if (t.correctRejection) correctRejections++;
    });

    const accuracyPercent = targetCount > 0 ? Math.round((hits / targetCount) * 100) : 0;
    const meanRtHits = rtsHits.length ? Math.round(avg(rtsHits)) : 0;

    const sessionId = "AEX-" + Date.now();
    const interpretation = interpretNBack(accuracyPercent, misses, falseAlarms);

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = `
        <h2>Risultati</h2>

        <p><strong>Livello N-Back. </strong>${N_LEVEL}</p>
        <p><strong>Tempo medio di risposta ai match corretti. </strong>${meanRtHits || "-"} ms</p>
        <p><strong>Target totali (match 2-back). </strong>${targetCount}</p>
        <p><strong>Risposte corrette ai target (hit). </strong>${hits}</p>
        <p><strong>Errori di omissione (nessuna risposta a un match). </strong>${misses}</p>
        <p><strong>Errori di commissione (risposta quando non c'era match). </strong>${falseAlarms}</p>
        <p><strong>Accuratezza sui target. </strong>${accuracyPercent} percent</p>

        <div class="badge-container">
            <div class="badge-label">Sintesi del tuo profilo in questo test</div>
            <div class="badge-pill ${interpretation.cssClass}">
                ${interpretation.label}
            </div>
        </div>

        <div id="legend">
            <h3>Come leggere questi dati</h3>
            <ul>
                <li>Il 2-back misura la capacità di mantenere e aggiornare nel tempo le informazioni in memoria di lavoro.</li>
                <li>Una buona performance richiede sia memoria che controllo attentivo. devi confrontare continuamente lo stimolo attuale con quello di due prove prima.</li>
                <li>Molti errori di omissione possono indicare difficoltà nel tenere il tracciato mentale della sequenza.</li>
                <li>Molti errori di commissione possono indicare risposte impulsive o confusione nella rappresentazione.</li>
            </ul>
        </div>

        <p class="note">
            I dati di questo test sono salvati in forma anonima e aggregata.  
            non raccogliamo nome, email o altri dati che permettano l'identificazione personale.  
            il tuo codice di sessione è <strong>${sessionId}</strong> e viene usato solo per analisi statistiche interne.
        </p>
    `;

    const payload = {
        sessionId: sessionId,
        nLevel: N_LEVEL,
        totalTrials: NUM_TRIALS,
        targetCount: targetCount,
        hits: hits,
        misses: misses,
        falseAlarms: falseAlarms,
        correctRejections: correctRejections,
        accuracy: accuracyPercent,
        meanRtHits: meanRtHits,
        extra: ""
    };

    fetch(WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload)
    }).catch(err => {
        console.error("Errore nell'invio al foglio Google:", err);
    });
}
</script>

</body>
</html>
